{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" crossorigin="anonymous"/>
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />
    {% block page_css %}{% endblock %}
    <title>{% block title %}UBlog{% endblock %}</title>
  </head>
  <body>
    {% block page_flags %}{% endblock %}

    <nav class="navbar navbar-expand-lg navbar-light navbar-custom" style="background-color:#00CCFF!important;">
      <a class="navbar-brand"
         href="{% if request.user.is_authenticated %}{% url 'postlistview' %}{% else %}{% url 'homeview' %}{% endif %}">
        UBlog
      </a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
              aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
          {% if request.user.is_authenticated %}
            <li class="nav-item"><a class="nav-link" href="{% url 'logoutview' %}">Logout</a></li>
            <li class="nav-item"><a class="nav-link" href="{% url 'profileview' request.user.id %}">Profile</a></li>
          {% else %}
            <li class="nav-item"><a class="nav-link" href="{% url 'loginview' %}">Login</a></li>
            <li class="nav-item"><a class="nav-link" href="{% url 'signupview' %}">Sign up</a></li>
          {% endif %}
          <li class="nav-item">
            <form class="form-inline my-2 my-lg-0 navbar-search" method="get" action="{% url 'search' %}">
              <input class="form-control mr-sm-2" id="search-input" type="text" name="q" placeholder="Search..." />
            </form>
          </li>
        </ul>
      </div>
    </nav>

    <div class="page-wrapper">
      {% block content %}{% endblock %}
    </div>

    <footer class="site-footer" role="contentinfo">
      <div class="footer-content">
        <span>© {% now "Y" %} UBlog • All rights reserved</span>
      </div>
    </footer>

    <div class="debug-overlay" aria-hidden="true">
      <div class="safe-top"></div>
      <div class="safe-bottom"></div>
      <div class="content-window"></div>
      <div class="badge">Debug: press D</div>
    </div>

    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js" crossorigin="anonymous"></script>

    <script>
      (function(){
        const root = document.documentElement;

        // Measures fixed bars and updates safe-area variables in px and vh.
        function updateSafeZones(){
          const nav = document.querySelector('.navbar-custom');
          const footer = document.querySelector('.site-footer');

          const navH = nav ? Math.ceil(nav.getBoundingClientRect().height) : 56;
          const footH = footer ? Math.ceil(footer.getBoundingClientRect().height) : 56;

          const TOP_BUFFER = 6;
          const BOT_BUFFER = 6;

          const topPx = navH + TOP_BUFFER;
          const bottomPx = footH + BOT_BUFFER;

          root.style.setProperty('--safe-top', topPx + 'px');
          root.style.setProperty('--safe-bottom', bottomPx + 'px');

          const viewport = window.innerHeight || 1;
          const topVh = (topPx / viewport) * 100;
          const bottomVh = (bottomPx / viewport) * 100;

          root.style.setProperty('--safe-top-vh', topVh.toFixed(2));
          root.style.setProperty('--safe-bottom-vh', bottomVh.toFixed(2));
        }

        function toggleDebug(){
          document.body.classList.toggle('debug-on');
        }

        function initDebugOverlay(){
          const overlay = document.querySelector('.debug-overlay');
          if (!overlay) return;

          const enabled = window.UBLOG && window.UBLOG.DEBUG_OVERLAY;
          if (!enabled){
            if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
            return;
          }

          const badge = overlay.querySelector('.badge');

          document.addEventListener('keydown', function(e){
            if (e.key === 'd' || e.key === 'D') toggleDebug();
          });

          if (badge){
            badge.addEventListener('click', toggleDebug);
          }
        }

        function layout(){
          updateSafeZones();
        }

        window.addEventListener('resize', layout);
        document.addEventListener('DOMContentLoaded', function(){
          layout();
          initDebugOverlay();
        });
      })();
    </script>

    {% block extra_scripts %}{% endblock %}
  </body>
</html>
