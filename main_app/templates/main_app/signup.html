{% extends "main_app/layouts/base.html" %}
{% load static %}

{% block title %}Sign up ‚Ä¢ UBlog{% endblock %}
{% block body_class %}auth-page{% endblock %}

{% block page_css %}
  <link rel="stylesheet" href="{% static 'css/auth.css' %}">
{% endblock %}

{% block content %}
<div class="auth-shell">
  <!-- Left: logo + tagline -->
  <div class="auth-brand-panel">
    <h1 class="auth-logo-wordmark">UBlog</h1>
    <p class="auth-tagline">
      Join a community of writers and readers. Create posts, follow authors,
      and build your own corner of the internet.
    </p>
  </div>

  <!-- Right: signup card -->
  <div class="auth-card">
    <form method="POST" action="">
      {% csrf_token %}
      <h2 class="auth-card-title">Create a new account</h2>

      <!-- Username -->
      <div class="form-group">
        <label for="id_username">Username</label>
        <input
          id="id_username"
          type="text"
          name="username"
          placeholder="Choose a username"
          autocomplete="username"
          required
        />
      </div>

      <!-- Email -->
      <div class="form-group">
        <label for="id_email">Email</label>
        <input
          id="id_email"
          type="email"
          name="email"
          placeholder="Enter your email"
          autocomplete="email"
          required
        />
      </div>

      <!-- Password -->
      <div class="form-group">
        <label for="id_password1">Password</label>
        <div class="auth-password-wrapper">
          <input
            id="id_password1"
            type="password"
            name="password1"
            placeholder="Create a password"
            autocomplete="new-password"
            required
          />
          <button
            type="button"
            class="auth-password-toggle"
            data-toggle="password"
            data-target="id_password1"
            aria-label="Show password"
          >
            <span class="auth-password-eye" aria-hidden="true">üëÅ</span>
          </button>
        </div>
        <div class="auth-password-hint">
          <ul class="auth-password-rules">
            <li data-rule="length" class="is-invalid">At least 8 characters</li>
            <li data-rule="number" class="is-invalid">Contains a number</li>
            <li data-rule="capital" class="is-invalid">Contains a capital letter</li>
            <li data-rule="special" class="is-invalid">Contains a special character</li>
            <li data-rule="match" class="is-invalid">Passwords match</li>
          </ul>
        </div>
      </div>

      <!-- Confirm password -->
      <div class="form-group">
        <label for="id_password2">Confirm password</label>
        <div class="auth-password-wrapper">
          <input
            id="id_password2"
            type="password"
            name="password2"
            placeholder="Re-enter your password"
            autocomplete="new-password"
            required
          />
          <button
            type="button"
            class="auth-password-toggle"
            data-toggle="password"
            data-target="id_password2"
            aria-label="Show password"
          >
            <span class="auth-password-eye" aria-hidden="true">üëÅ</span>
          </button>
        </div>
      </div>

      <!-- Submit -->
      <button class="btn btn-primary auth-btn-primary" type="submit">
        Sign up
      </button>

      <!-- Django messages (form errors, etc.) -->
      {% if messages %}
      <div class="auth-messages">
        {% for message in messages %}
          <p class="auth-message {{ message.tags }}">{{ message }}</p>
        {% endfor %}
      </div>
      {% endif %}

      <div class="auth-divider"><span>or</span></div>

      <a href="{% url 'loginview' %}" class="btn auth-btn-secondary">
        Log in to existing account
      </a>
    </form>

    <p class="auth-small-link mt-3 mb-0">
      <a href="{% url 'homeview' %}">Back to landing</a>
    </p>

    <p class="auth-small-link mt-2 mb-0">
      Already signed up but no email? <a href="{% url 'resend_verification' %}">Resend verification</a>
    </p>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  (function(){
    function setupPasswordToggles(){
      document.querySelectorAll('[data-toggle="password"]').forEach(function(btn){
        var targetId = btn.getAttribute('data-target');
        var input = document.getElementById(targetId);
        if (!input) return;

        btn.addEventListener('click', function(){
          var isPassword = input.type === 'password';
          input.type = isPassword ? 'text' : 'password';
          btn.classList.toggle('is-visible', isPassword);
          btn.setAttribute('aria-pressed', String(isPassword));
        });
      });
    }

    function setupPasswordFeedback(){
      var pwd1 = document.getElementById('id_password1');
      var pwd2 = document.getElementById('id_password2');
      var form = pwd1 ? pwd1.form : null;
      if (!pwd1 || !pwd2 || !form) return;

      var rules = {
        length: document.querySelector('[data-rule="length"]'),
        number: document.querySelector('[data-rule="number"]'),
        capital: document.querySelector('[data-rule="capital"]'),
        special: document.querySelector('[data-rule="special"]'),
        match:  document.querySelector('[data-rule="match"]')
      };

      var lastAllOk = false;

      function applyRule(ruleName, ok){
        var el = rules[ruleName];
        if (!el) return;
        el.classList.toggle('is-valid', ok);
        el.classList.toggle('is-invalid', !ok);
      }

      function update(){
        var v1 = pwd1.value || '';
        var v2 = pwd2.value || '';

        var checks = {
          length: v1.length >= 8,
          number: /\d/.test(v1),
          capital: /[A-Z]/.test(v1),
          special: /[^A-Za-z0-9]/.test(v1),
          match: v1.length > 0 && v1 === v2
        };

        for (var key in checks){
          applyRule(key, checks[key]);
        }

        lastAllOk =
          checks.length &&
          checks.number &&
          checks.capital &&
          checks.special &&
          checks.match;
      }

      pwd1.addEventListener('input', update);
      pwd2.addEventListener('input', update);

      form.addEventListener('submit', function(e){
        update();
        if (!lastAllOk){
          e.preventDefault();
          pwd1.focus();
        }
      });

      update();
    }

    document.addEventListener('DOMContentLoaded', function(){
      setupPasswordToggles();
      setupPasswordFeedback();
    });
  })();
</script>
{% endblock %}