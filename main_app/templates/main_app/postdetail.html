{# path: templates/main_app/postdetail.html #}
{% extends "main_app/layouts/feed_base.html" %}
{% load static %}

{% block feed_title %}{{ post.title }}{% endblock %}

{% block feed_main %}
  <div class="feed-column">
    <!-- Main post -->
    {% include "main_app/partials/post_card.html" with post=post is_detail=True score=score %}

    <!-- Comments section -->
    <section id="comments" class="post-card comment-card">
      <div class="comment-header">
        <h3>Comments</h3>
        <div class="comment-meta-chip">
          <i class="fa-regular fa-message"></i>
          <span>{{ post.comments.count }}</span>
        </div>
      </div>

      {% if request.user.is_authenticated %}
        <form id="root_comment_form"
              method="post"
              action="{% url 'add_comment_like' post.pk %}"
              class="comment-form">
          {% csrf_token %}
          <textarea name="comment_text"
                    rows="3"
                    required
                    placeholder="What are your thoughts?"></textarea>
          <input type="hidden"
                 name="next"
                 value="{% url 'postdetailview' post.pk %}#comments">
          <button type="submit"
                  name="comment_button"
                  value="1"
                  class="btn btn-primary">
            Comment
          </button>
        </form>
      {% else %}
        <p class="comment-empty">
          <a href="{% url 'loginview' %}">Log in</a> or
          <a href="{% url 'signupview' %}">sign up</a> to comment.
        </p>
      {% endif %}

      {% if post.comments.exists %}
        <ul class="comment-thread">
          {% for c in post.comments.all %}
            {% if not c.parent_id %}
              {% include "main_app/partials/comment_item.html" with node=c post_id=post.pk %}
            {% endif %}
          {% endfor %}
        </ul>
      {% else %}
        <p class="comment-empty">
          No comments yet. Be the first to share what you think!
        </p>
      {% endif %}
    </section>
  </div>
{% endblock %}
